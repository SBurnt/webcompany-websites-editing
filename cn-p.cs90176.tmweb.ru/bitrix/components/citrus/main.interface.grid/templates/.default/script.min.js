function BxInterfaceGrid(e){this.oActions={},this.oColsMeta={},this.oColsNames={},this.customNames={},this.oEditData={},this.oSaveData={},this.oOptions={},this.oVisibleCols=null,this.vars={},this.menu=null,this.settingsMenu=[],this.filterMenu=[],this.checkBoxCount=0,this.bColsChanged=!1,this.bViewsChanged=!1,this.oFilterRows={},this.activeRow=null;var t=this;this.table_id=e,this.InitTable=function(){var e=document.getElementById(this.table_id);if(!(!e||e.rows.length<1||e.rows[0].cells.length<1)){var i,s=e.rows[0].cells.length;for(i=0;s>i;i++){var a;for(a=0;2>a;a++){var n=e.rows[a].cells[i];if(n.onmouseover=function(){t.HighlightGutter(this,!0)},n.onmouseout=function(){t.HighlightGutter(this,!1)},1==a){if(n.className&&("bx-actions-col"==n.className||"bx-checkbox-col"==n.className))continue;this.vars.user_authorized&&(n.onbxdragstart=t.DragStart,n.onbxdragstop=t.DragStop,n.onbxdrag=t.Drag,n.onbxdraghout=function(){t.HighlightGutter(this,!1)},jsDD.registerObject(n),n.onbxdestdraghover=t.DragHover,n.onbxdestdraghout=t.DragOut,n.onbxdestdragfinish=t.DragFinish,jsDD.registerDest(n))}}}var l=e.rows.length;for(i=0;l>i;i++){var o=e.rows[i];if(!o.className||"bx-grid-footer"!=o.className){if(o.cells[0].className+=" bx-left",o.cells[o.cells.length-1].className+=" bx-right",i>=2){var r=o.cells[0].childNodes[0];r&&r.tagName&&"INPUT"==r.tagName.toUpperCase()&&"CHECKBOX"==r.type.toUpperCase()&&(r.onclick=function(){t.SelectRow(this),t.EnableActions()},jsUtils.addEvent(o,"click",t.OnClickRow),this.checkBoxCount++),o.onmouseover=function(){t.HighlightRow(this,!0)},o.onmouseout=function(){t.HighlightRow(this,!1)},o.className+=i%2==0?" bx-odd":" bx-even"}o.oncontextmenu&&jsUtils.addEvent(o,"contextmenu",this.OnRowContext)}}if(e.rows.length>2){e.rows[2].className+=" bx-top";var c=e.rows[e.rows.length-1];c.className&&"bx-grid-footer"==c.className&&(c=e.rows[e.rows.length-2]),c.className+=" bx-bottom"}}},this.OnRowContext=function(e){if(t.menu&&(e||(e=window.event),!(!phpVars.opt_context_ctrl&&e.ctrlKey||phpVars.opt_context_ctrl&&!e.ctrlKey))){var i;e.target?i=e.target:e.srcElement&&(i=e.srcElement);for(var s=i;s&&(!s.tagName||"TD"!=s.tagName.toUpperCase()||!s.oncontextmenu);)s=jsUtils.FindParentObject(s,"td");var a=null;for(s&&s.oncontextmenu&&(a=s.oncontextmenu(),a[a.length]={SEPARATOR:!0}),s=i;s&&(!s.tagName||"TR"!=s.tagName.toUpperCase()||!s.oncontextmenu);)s=jsUtils.FindParentObject(s,"tr");var n=t.menu;n.PopupHide(),t.activeRow=s,!t.activeRow||BX.hasClass(s,"bx-grid-gutter")||BX.hasClass(s,"bx-grid-head")||(t.activeRow.className+=" bx-active"),n.OnClose=function(){t.activeRow&&(t.activeRow.className=t.activeRow.className.replace(/\s*bx-active/i,""),t.activeRow=null),t.SaveColumns()};var l=BX.util.array_merge(a,s.oncontextmenu());if(0!=l.length){n.SetItems(l),n.BuildItems();var o=jsUtils.GetWindowScrollPos(),r=e.clientX+o.scrollLeft,c=e.clientY+o.scrollTop,d={};d.left=d.right=r,d.top=d.bottom=c,n.PopupShow(d),e.returnValue=!1,e.preventDefault&&e.preventDefault()}}},this.ShowActionMenu=function(e,i){t.menu.PopupHide(),t.activeRow=jsUtils.FindParentObject(e,"tr"),t.activeRow&&(t.activeRow.className+=" bx-active"),t.menu.ShowMenu(e,t.oActions[i],!1,!1,function(){t.activeRow&&(t.activeRow.className=t.activeRow.className.replace(/\s*bx-active/i,""),t.activeRow=null)})},this.HighlightGutter=function(e,t){var i=e.parentNode.parentNode.parentNode,s=i.rows[0].cells[e.cellIndex],a=-1!=s.className.indexOf("bx-sorted");t?a?(s.className+=" bx-over-sorted",e.className+=" bx-over-sorted"):(s.className+=" bx-over",e.className+=" bx-over"):a?(s.className=s.className.replace(/\s*bx-over-sorted/i,""),e.className=e.className.replace(/\s*bx-over-sorted/i,"")):(s.className=s.className.replace(/\s*bx-over/i,""),e.className=e.className.replace(/\s*bx-over/i,""))},this.HighlightRow=function(e,t){t?e.className+=" bx-over":e.className=e.className.replace(/\s*bx-over/i,"")},this.SelectRow=function(e){var t=e.parentNode.parentNode,i=t.parentNode.parentNode,s=document.getElementById(i.id+"_selected_span"),a=parseInt(s.innerHTML);e.checked?(t.className+=" bx-selected",a++):(t.className=t.className.replace(/\s*bx-selected/gi,""),a--),s.innerHTML=a.toString();var n=document.getElementById(i.id+"_check_all");n.checked=a==this.checkBoxCount?!0:!1},this.OnClickRow=function(e){if(e||(e=window.event),e.ctrlKey){var i=e.target?e.target:e.srcElement?e.srcElement:null;if(i&&i.parentNode.cells){var s=i.parentNode.cells[0].childNodes[0];s&&s.tagName&&"INPUT"==s.tagName.toUpperCase()&&"CHECKBOX"==s.type.toUpperCase()&&!s.disabled&&(s.checked=!s.checked,t.SelectRow(s)),t.EnableActions()}}},this.SelectAllRows=function(e){var t,i=document.getElementById(this.table_id),s=e.checked,a=i.rows.length;for(t=2;a>t;t++){var n=i.rows[t].cells[0].childNodes[0];n&&n.tagName&&"INPUT"==n.tagName.toUpperCase()&&"CHECKBOX"==n.type.toUpperCase()&&(n.checked==s||n.disabled||(n.checked=s,this.SelectRow(n)))}this.EnableActions()},this.EnableActions=function(){var e=document.forms["form_"+this.table_id];if(e){var t=this.IsActionEnabled(),i=this.IsActionEnabled("edit");e.apply&&(e.apply.disabled=!t);var s=document.getElementById("edit_button_"+this.table_id);s&&(s.className="context-button icon action-edit-button"+(i?"":"-dis")),s=document.getElementById("delete_button_"+this.table_id),s&&(s.className="context-button icon action-delete-button"+(t?"":"-dis"))}},this.IsActionEnabled=function(e){var t=document.forms["form_"+this.table_id];if(t){var i=!1,s=document.getElementById(this.table_id+"_selected_span");s&&parseInt(s.innerHTML)>0&&(i=!0);var a=t["action_all_rows_"+this.table_id];return"edit"==e?!(a&&a.checked)&&i:a&&a.checked||i}},this.SwitchActionButtons=function(e){for(var t=document.getElementById("bx_grid_"+this.table_id+"_action_buttons"),i=t;i=jsUtils.FindNextSibling(i,"td");)i.style.display=e?"none":"";t.style.display=e?"":"none"},this.ActionEdit=function(){if(this.IsActionEnabled("edit")){var e=document.forms["form_"+this.table_id];if(!e)return;this.SwitchActionButtons(!0);var t=e["ID[]"];t.length||(t=new Array(t));for(var i=0;i<t.length;i++){var s=t[i];if(s.checked){var a=jsUtils.FindParentObject(s,"tr");BX.denyEvent(a,"dblclick");var n=jsUtils.FindParentObject(s,"td");n=jsUtils.FindNextSibling(n,"td"),"bx-actions-col"==n.className&&(n=jsUtils.FindNextSibling(n,"td"));var l=s.value;this.oSaveData[l]={};for(var o in this.oColsMeta){if(1==this.oColsMeta[o].editable&&this.oEditData[l][o]!==!1){this.oSaveData[l][o]=n.innerHTML,n.innerHTML="";var r=this.oEditData[l][o],c="FIELDS["+l+"]["+o+"]";switch(this.oColsMeta[o].type){case"checkbox":n.appendChild(BX.create("INPUT",{props:{type:"hidden",name:c,value:"N"}})),n.appendChild(BX.create("INPUT",{props:{type:"checkbox",name:c,value:"Y",checked:"Y"==r,defaultChecked:"Y"==r}}));break;case"list":var d=[];for(var h in this.oColsMeta[o].items)d[d.length]=BX.create("OPTION",{props:{value:h,selected:h==r},text:this.oColsMeta[o].items[h]});n.appendChild(BX.create("SELECT",{props:{name:c},children:d}));break;case"date":var v=BX.create("SPAN",{style:{whiteSpace:"nowrap"}});v.appendChild(BX.create("INPUT",{props:{type:"text",name:c,value:r,size:this.oColsMeta[o].size?this.oColsMeta[o].size:10}})),v.appendChild(BX.create("A",{props:{href:"javascript:void(0);",title:this.vars.mess.calend_title},html:'<img src="'+this.vars.calendar_image+'" alt="'+this.vars.mess.calend_title+'" class="calendar-icon" onclick="BX.calendar({node:this, field:\''+c+"', bTime: true, currentTime: '"+this.vars.server_time+'\'});" onmouseover="this.className+=\' calendar-icon-hover\';" onmouseout="this.className = this.className.replace(/s*calendar-icon-hover/ig, \'\');" border="0"/>'})),n.appendChild(v);break;default:var m={type:"text",name:c,value:r,size:this.oColsMeta[o].size?this.oColsMeta[o].size:15};this.oColsMeta[o].maxlength&&(m.maxLength=this.oColsMeta[o].maxlength),n.appendChild(BX.create("INPUT",{props:m}))}}n=jsUtils.FindNextSibling(n,"td")}}s.disabled=!0}e.elements["action_button_"+this.table_id].value="edit"}},this.ActionCancel=function(){var e=document.forms["form_"+this.table_id];if(e){this.SwitchActionButtons(!1);var t=e["ID[]"];t.length||(t=new Array(t));for(var i=0;i<t.length;i++){var s=t[i];if(s.checked){var a=jsUtils.FindParentObject(s,"tr");BX.allowEvent(a,"dblclick");var n=jsUtils.FindParentObject(s,"td");n=jsUtils.FindNextSibling(n,"td"),"bx-actions-col"==n.className&&(n=jsUtils.FindNextSibling(n,"td"));var l=s.value;for(var o in this.oColsMeta)1==this.oColsMeta[o].editable&&this.oEditData[l][o]!==!1&&(n.innerHTML=this.oSaveData[l][o]),n=jsUtils.FindNextSibling(n,"td")}s.disabled=!1}e.elements["action_button_"+this.table_id].value=""}},this.ActionDelete=function(){var e=document.forms["form_"+this.table_id];e&&(e.elements["action_button_"+this.table_id].value="delete",BX.submit(e))},this.DeleteItem=function(e,t){var i=document.getElementById("ID_"+e);if(i&&confirm(t)){var s=document.forms["form_"+this.table_id];if(!s)return;var a=s["ID[]"];a.length||(a=new Array(a));for(var n=0;n<a.length;n++)a[n].checked=!1;i.checked=!0,this.ActionDelete()}},this.ForAllClick=function(e){if(e.checked&&!confirm(this.vars.mess.for_all_confirm))return void(e.checked=!1);var t=e.form["ID[]"];if(t){t.length||(t=new Array(t));for(var i=0;i<t.length;i++)t[i].disabled=e.checked}this.EnableActions()},this.Sort=function(e,i,s,a,n){var l;if(""==s){var o=null,r=!1;n.length>0&&(o=n[0]),o||(o=window.event),o&&(r=o.ctrlKey),l=r?"acs"==a?"desc":"asc":a}else l="asc"==s?"desc":"asc";e+=l,BX.ajax.get("/bitrix/components"+t.vars.component_path+"/settings.php?GRID_ID="+t.table_id+"&action=savesort&by="+i+"&order="+l+"&sessid="+t.vars.sessid,function(){t.Reload(e)})},this.InitVisCols=function(){if(null==this.oVisibleCols){this.oVisibleCols={};for(var e in this.oColsMeta)this.oVisibleCols[e]=!0}},this.CheckColumn=function(e,t){var i=this.menu.GetMenuByItemId(t.id),s=!("checked"==i.GetItemInfo(t).ICON);i.SetItemIcon(t,s?"checked":""),this.InitVisCols(),this.oVisibleCols[e]=s,this.bColsChanged=!0},this.HideColumn=function(e){this.InitVisCols(),this.oVisibleCols[e]=!1,this.bColsChanged=!0,this.SaveColumns()},this.ApplySaveColumns=function(){this.menu.PopupHide(),this.SaveColumns()},this.SaveColumns=function(e){var i="";if(e)i=e;else{if(!t.bColsChanged)return;for(var s in t.oVisibleCols)t.oVisibleCols[s]&&(i+=(""!=i?",":"")+s)}BX.ajax.get("/bitrix/components"+t.vars.component_path+"/settings.php?GRID_ID="+t.table_id+"&action=showcolumns&columns="+i+"&sessid="+t.vars.sessid,function(){t.Reload()})},this.Reload=function(e){jsDD.Disable(),e||(e=this.vars.current_url),""!=this.vars.ajax.AJAX_ID?BX.ajax.insertToNode(e+(-1==e.indexOf("?")?"?":"&")+"bxajaxid="+this.vars.ajax.AJAX_ID,"comp_"+this.vars.ajax.AJAX_ID):window.location=e},this.SetTheme=function(e,i){BX.loadCSS(this.vars.template_path+"/themes/"+i+"/style.css"),BX(t.table_id).className="bx-interface-grid bx-interface-grid-theme-"+i;var s=this.menu.GetMenuByItemId(e.id);s.SetAllItemsIcon(""),s.SetItemIcon(e,"checked"),BX.ajax.get("/bitrix/components"+t.vars.component_path+"/settings.php?GRID_ID="+t.table_id+"&action=settheme&theme="+i+"&sessid="+t.vars.sessid)},this.SetView=function(e){var i=t.oOptions.views[e].saved_filter,s=i&&t.oOptions.filters[i]?function(){t.ApplyFilter(i)}:function(){t.Reload()};BX.ajax.get("/bitrix/components"+t.vars.component_path+"/settings.php?GRID_ID="+t.table_id+"&action=setview&view_id="+e+"&sessid="+t.vars.sessid,s)},this.EditCurrentView=function(){this.ShowSettings(this.oOptions.views[this.oOptions.current_view],function(){t.SaveSettings(t.oOptions.current_view,!0)})},this.AddView=function(){var e="view_"+Math.round(1e6*Math.random()),i={};for(var s in this.oOptions.views[this.oOptions.current_view])i[s]=this.oOptions.views[this.oOptions.current_view][s];i.name=this.vars.mess.viewsNewView,this.ShowSettings(i,function(){var i=t.SaveSettings(e);t.oOptions.views[e]={name:i.name,columns:i.columns,sort_by:i.sort_by,sort_order:i.sort_order,page_size:i.page_size,saved_filter:i.saved_filter,custom_names:i.custom_names},t.bViewsChanged=!0;var s=document["views_"+t.table_id];s.views_list.options[s.views_list.length]=new Option(""!=i.name?i.name:t.vars.mess.viewsNoName,e,!0,!0)})},this.EditView=function(e){this.ShowSettings(this.oOptions.views[e],function(){var i=t.SaveSettings(e);t.oOptions.views[e]={name:i.name,columns:i.columns,sort_by:i.sort_by,sort_order:i.sort_order,page_size:i.page_size,saved_filter:i.saved_filter,custom_names:i.custom_names},t.bViewsChanged=!0;var s=document["views_"+t.table_id];s.views_list.options[s.views_list.selectedIndex].text=""!=i.name?i.name:t.vars.mess.viewsNoName})},this.DeleteView=function(e){if(confirm(this.vars.mess.viewsDelete)){var i=document["views_"+this.table_id],s=i.views_list.selectedIndex;i.views_list.remove(s),i.views_list.selectedIndex=s<i.views_list.length?s:i.views_list.length-1,this.bViewsChanged=!0,BX.ajax.get("/bitrix/components"+this.vars.component_path+"/settings.php?GRID_ID="+this.table_id+"&action=delview&view_id="+e+"&sessid="+t.vars.sessid)}},this.ShowSettings=function(e,t){var i=!1;window["settingsDialog"+this.table_id]||(window["settingsDialog"+this.table_id]=new BX.CDialog({content:'<form name="settings_'+this.table_id+'"></form>',title:this.vars.mess.settingsTitle,width:this.vars.settingWndSize.width,height:this.vars.settingWndSize.height,resize_id:"InterfaceGridSettingWnd"}),i=!0),window["settingsDialog"+this.table_id].ClearButtons(),window["settingsDialog"+this.table_id].SetButtons([{title:this.vars.mess.settingsSave,action:function(){t(),this.parentWindow.Close()}},BX.CDialog.prototype.btnCancel]),window["settingsDialog"+this.table_id].Show();var s=document["settings_"+this.table_id];i&&s.appendChild(BX("view_settings_"+this.table_id)),this.customNames=e.custom_names?e.custom_names:{},s.view_name.focus(),s.view_name.value=e.name;var a=[];if(""!=e.columns)a=e.columns.split(",");else for(var n in this.oColsMeta)a[a.length]=n;var l,o={};for(n=0,l=a.length;l>n;n++)o[a[n]]=!0;jsSelectUtils.deleteAllOptions(s.view_all_cols);for(n in this.oColsNames)if(!o[n]){var r=this.customNames[n]?this.customNames[n]:this.oColsNames[n];s.view_all_cols.options[s.view_all_cols.length]=new Option(r,n,!1,!1)}jsSelectUtils.deleteAllOptions(s.view_cols);for(n in o)r=this.customNames[n]?this.customNames[n]:this.oColsNames[n],s.view_cols.options[s.view_cols.length]=new Option(r,n,!1,!1);jsSelectUtils.selectOption(s.view_sort_by,e.sort_by),jsSelectUtils.selectOption(s.view_sort_order,e.sort_order),jsSelectUtils.selectOption(s.view_page_size,e.page_size),jsSelectUtils.deleteAllOptions(s.view_filters),s.view_filters.options[0]=new Option(this.vars.mess.viewsFilter,"");for(n in this.oOptions.filters)s.view_filters.options[s.view_filters.length]=new Option(this.oOptions.filters[n].name,n,n==e.saved_filter,n==e.saved_filter);s.set_default_settings&&(s.set_default_settings.checked=!1,s.delete_users_settings.checked=!1,s.delete_users_settings.disabled=!0),s.up_btn.disabled=s.down_btn.disabled=s.rename_btn.disabled=s.add_btn.disabled=s.del_btn.disabled=!0},this.RenameColumn=function(){var e=!1;window["renameDialog"+this.table_id]||(window["renameDialog"+this.table_id]=new BX.CDialog({content:'<form name="rename_'+this.table_id+'"></form>',title:this.vars.mess.renameTitle,width:this.vars.renameWndSize.width,height:this.vars.renameWndSize.height,resize_id:"InterfaceGridRenameWnd",buttons:[{title:this.vars.mess.settingsSave,action:function(){var e=s.view_cols.value,a=i.col_name.value;a.length>0?t.customNames[e]=a:(a=t.oColsNames[e],delete t.customNames[e]),s.view_cols.options[s.view_cols.selectedIndex].text=a,this.parentWindow.Close()}},BX.CDialog.prototype.btnCancel]}),e=!0),window["renameDialog"+this.table_id].Show();var i=document["rename_"+this.table_id],s=document["settings_"+this.table_id];e&&i.appendChild(BX("rename_column_"+this.table_id));var a=s.view_cols.value;i.col_name.focus(),i.col_name_def.value=this.oColsNames[a],i.col_name.value=this.customNames[a]?this.customNames[a]:this.oColsNames[a]},this.SaveSettings=function(e,i){for(var s=document["settings_"+this.table_id],a="",n=s.view_cols.length,l=0;n>l;l++)a+=(""!=a?",":"")+s.view_cols[l].value;var o={GRID_ID:this.table_id,view_id:e,action:"savesettings",sessid:this.vars.sessid,name:s.view_name.value,columns:a,sort_by:s.view_sort_by.value,sort_order:s.view_sort_order.value,page_size:s.view_page_size.value,saved_filter:s.view_filters.value,custom_names:this.customNames};s.set_default_settings&&(o.set_default_settings=s.set_default_settings.checked?"Y":"N",o.delete_users_settings=s.delete_users_settings.checked?"Y":"N");var r=null;return i===!0&&(r=function(){o.saved_filter&&t.oOptions.filters[o.saved_filter]?t.ApplyFilter(o.saved_filter):t.Reload()}),BX.ajax.post("/bitrix/components"+t.vars.component_path+"/settings.php",o,r),o},this.ReloadViews=function(){t.bViewsChanged&&t.Reload()},this.ShowViews=function(){this.bViewsChanged=!1;var e=!1;if(!window["viewsDialog"+this.table_id]){var i=new BX.CWindowButton({title:this.vars.mess.viewsApply,hint:this.vars.mess.viewsApplyTitle,action:function(){var e=document["views_"+t.table_id];-1!=e.views_list.selectedIndex&&t.SetView(e.views_list.value),window["bxGrid_"+t.table_id].bViewsChanged=!1,this.parentWindow.Close()}});window["viewsDialog"+this.table_id]=new BX.CDialog({content:'<form name="views_'+this.table_id+'"></form>',title:this.vars.mess.viewsTitle,buttons:[i,BX.CDialog.prototype.btnClose],width:this.vars.viewsWndSize.width,height:this.vars.viewsWndSize.height,resize_id:"InterfaceGridViewsWnd"}),BX.addCustomEvent(window["viewsDialog"+this.table_id],"onWindowUnRegister",this.ReloadViews),e=!0}window["viewsDialog"+this.table_id].Show();var s=document["views_"+this.table_id];e&&s.appendChild(BX("views_list_"+this.table_id))},this.DragStart=function(){var e=document.body.appendChild(document.createElement("DIV"));e.style.position="absolute",e.style.zIndex=10,e.className="bx-drag-object",e.innerHTML=this.innerHTML,e.style.width=this.clientWidth+"px",this.__dragCopyDiv=e,this.className+=" bx-drag-source";var t=document.body.appendChild(document.createElement("DIV"));return t.style.position="absolute",t.style.zIndex=20,t.className="bx-drag-arrow",this.__dragArrowDiv=t,!0},this.Drag=function(e,t){var i=this.__dragCopyDiv;return i.style.left=e+"px",i.style.top=t+"px",!0},this.DragStop=function(){return this.className=this.className.replace(/\s*bx-grid-drag-source/gi,""),this.__dragCopyDiv.parentNode.removeChild(this.__dragCopyDiv),this.__dragCopyDiv=null,this.__dragArrowDiv.parentNode.removeChild(this.__dragArrowDiv),this.__dragArrowDiv=null,!0},this.DragHover=function(e){t.HighlightGutter(this,!0),this.className+=" bx-drag-over";var i=e.__dragArrowDiv,s=jsUtils.GetRealPos(this);return i.style.left=this.cellIndex<=e.cellIndex?s.left-6+"px":s.right-6+"px",i.style.top=s.top-12+"px",!0},this.DragOut=function(e){t.HighlightGutter(this,!1),this.className=this.className.replace(/\s*bx-drag-over/gi,"");var i=e.__dragArrowDiv;return i.style.left="-1000px",!0},this.DragFinish=function(e){if(t.HighlightGutter(this,!1),this.className=this.className.replace(/\s*bx-drag-over/gi,""),this==e)return!0;for(var i=BX(t.table_id),s=0,a=0;2>a;a++){var n=i.rows[1].cells[a];!n.className||-1==n.className.indexOf("bx-actions-col")&&-1==n.className.indexOf("bx-checkbox-col")||s++}var l=[];for(var o in t.oColsMeta)l[l.length]=o;var r=e.cellIndex-s,c=this.cellIndex-s,d=l[r];if(r>c)for(a=r;a>c;a--)l[a]=l[a-1];else for(a=r;c>a;a++)l[a]=l[a+1];l[c]=d;var h="";for(a=0;a<l.length;a++)h+=(""!=h?",":"")+l[a];return t.SaveColumns(h),!0},this.InitFilter=function(){var e=BX("flt_header_"+this.table_id);e&&jsUtils.addEvent(e,"contextmenu",this.OnRowContext)},this.SwitchFilterRow=function(e,t){if(t){var i=this.menu.GetMenuByItemId(t.id);i.SetItemIcon(t,this.oFilterRows[e]?"":"checked")}else for(var s=this.filterMenu[0].MENU,a=0;a<s.length;a++)if(s[a].ID=="flt_"+this.table_id+"_"+e){s[a].ICONCLASS=this.oFilterRows[e]?"":"checked";break}var n=BX("flt_row_"+this.table_id+"_"+e);n.style.display=this.oFilterRows[e]?"none":"",this.oFilterRows[e]=this.oFilterRows[e]?!1:!0;var l=BX("a_minmax_"+this.table_id);l&&-1!=l.className.indexOf("bx-filter-max")&&this.SwitchFilter(l),this.SaveFilterRows()},this.SwitchFilterRows=function(e){this.menu.PopupHide();var t=0;for(var i in this.oFilterRows)if(t++,1!=t||0!=e){this.oFilterRows[i]=e;var s=BX("flt_row_"+this.table_id+"_"+i);s.style.display=e?"":"none"}var a=this.filterMenu[0].MENU;for(t=0;t<a.length;t++)if(0!=t||0!=e){if(1==a[t].SEPARATOR)break;a[t].ICONCLASS=e?"checked":""}var n=BX("a_minmax_"+this.table_id);n&&-1!=n.className.indexOf("bx-filter-max")&&this.SwitchFilter(n),this.SaveFilterRows()},this.SaveFilterRows=function(){var e="";for(var t in this.oFilterRows)this.oFilterRows[t]&&(e+=(""!=e?",":"")+t);BX.ajax.get("/bitrix/components"+this.vars.component_path+"/settings.php?GRID_ID="+this.table_id+"&action=filterrows&rows="+e+"&sessid="+this.vars.sessid)},this.SwitchFilter=function(e){var t=e.classList.contains("_min"),i=e.parentNode;i.classList[t?"remove":"add"]("_shown");var s=BX("flt_content_"+this.table_id);s.style.display=t?"none":"",BX.ajax.get("/bitrix/components"+this.vars.component_path+"/settings.php?GRID_ID="+this.table_id+"&action=filterswitch&show="+(t?"N":"Y")+"&sessid="+this.vars.sessid)},this.ClearFilter=function(e){for(var t=0,i=e.elements.length;i>t;t++){var s=e.elements[t];switch(s.type.toLowerCase()){case"text":case"textarea":s.value="";break;case"select-one":s.selectedIndex=0;break;case"select-multiple":for(var a=0,n=s.options.length;n>a;a++)s.options[a].selected=!1;break;case"checkbox":s.checked=!1}s.onchange&&s.onchange()}BX.onCustomEvent(e,"onGridClearFilter",[]),e.clear_filter.value="Y",BX.submit(e)},this.ShowFilters=function(){var e=!1;if(!window["filtersDialog"+this.table_id]){var i=new BX.CWindowButton({title:this.vars.mess.filtersApply,hint:this.vars.mess.filtersApplyTitle,action:function(){var e=document["filters_"+t.table_id];e.filters_list.value&&t.ApplyFilter(e.filters_list.value),this.parentWindow.Close()}});window["filtersDialog"+this.table_id]=new BX.CDialog({content:'<form name="filters_'+this.table_id+'"></form>',title:this.vars.mess.filtersTitle,buttons:[i,BX.CDialog.prototype.btnClose],width:this.vars.filtersWndSize.width,height:this.vars.filtersWndSize.height,resize_id:"InterfaceGridFiltersWnd"}),e=!0}window["filtersDialog"+this.table_id].Show();var s=document["filters_"+this.table_id];e&&s.appendChild(BX("filters_list_"+this.table_id))},this.AddFilter=function(e){e||(e={});var i="filter_"+Math.round(1e6*Math.random()),s={name:this.vars.mess.filtersNew,fields:e};this.ShowFilterSettings(s,function(){var e=t.SaveFilter(i);t.oOptions.filters[i]={name:e.name,fields:e.fields};var s=document["filters_"+t.table_id];s.filters_list.options[s.filters_list.length]=new Option(""!=e.name?e.name:t.vars.mess.viewsNoName,i,!0,!0),4==t.filterMenu.length&&(t.filterMenu=BX.util.insertIntoArray(t.filterMenu,1,{SEPARATOR:!0}));var a={ID:"mnu_"+t.table_id+"_"+i,TEXT:BX.util.htmlspecialchars(e.name),TITLE:t.vars.mess.ApplyTitle,ONCLICK:"bxGrid_"+t.table_id+".ApplyFilter('"+i+"')"};t.filterMenu=BX.util.insertIntoArray(t.filterMenu,2,a)})},this.AddFilterAs=function(){var e=document.forms["filter_"+this.table_id],t=this.GetFilterFields(e);this.ShowFilters(),this.AddFilter(t)},this.EditFilter=function(e){this.ShowFilterSettings(this.oOptions.filters[e],function(){var i=t.SaveFilter(e);t.oOptions.filters[e]={name:i.name,fields:i.fields};var s=document["filters_"+t.table_id];s.filters_list.options[s.filters_list.selectedIndex].text=""!=i.name?i.name:t.vars.mess.viewsNoName;for(var a=0,n=t.filterMenu.length;n>a;a++)if(t.filterMenu[a].ID&&t.filterMenu[a].ID=="mnu_"+t.table_id+"_"+e){t.filterMenu[a].TEXT=BX.util.htmlspecialchars(i.name);break}})},this.DeleteFilter=function(e){if(confirm(this.vars.mess.filtersDelete)){var i=document["filters_"+this.table_id],s=i.filters_list.selectedIndex;i.filters_list.remove(s),i.filters_list.selectedIndex=s<i.filters_list.length?s:i.filters_list.length-1;for(var a=0,n=this.filterMenu.length;n>a;a++)if(t.filterMenu[a].ID&&t.filterMenu[a].ID=="mnu_"+t.table_id+"_"+e){this.filterMenu=BX.util.deleteFromArray(this.filterMenu,a),5==this.filterMenu.length&&(this.filterMenu=BX.util.deleteFromArray(this.filterMenu,1));break}delete this.oOptions.filters[e],BX.ajax.get("/bitrix/components"+this.vars.component_path+"/settings.php?GRID_ID="+this.table_id+"&action=delfilter&filter_id="+e+"&sessid="+t.vars.sessid)}},this.ShowFilterSettings=function(e,t){var i=!1;window["filterSettingsDialog"+this.table_id]||(window["filterSettingsDialog"+this.table_id]=new BX.CDialog({content:'<form name="flt_settings_'+this.table_id+'"></form>',title:this.vars.mess.filterSettingsTitle,width:this.vars.filterSettingWndSize.width,height:this.vars.filterSettingWndSize.height,resize_id:"InterfaceGridFilterSettingWnd"}),i=!0),window["filterSettingsDialog"+this.table_id].ClearButtons(),window["filterSettingsDialog"+this.table_id].SetButtons([{title:this.vars.mess.settingsSave,action:function(){t(),this.parentWindow.Close()}},BX.CDialog.prototype.btnCancel]),window["filterSettingsDialog"+this.table_id].Show();var s=document["flt_settings_"+this.table_id];i&&s.appendChild(BX("filter_settings_"+this.table_id)),s.filter_name.focus(),s.filter_name.value=e.name,this.SetFilterFields(s,e.fields)},this.SetFilterFields=function(e,t){for(var i=0,s=e.elements.length;s>i;i++){var a=e.elements[i];if("filter_name"!=a.name){var n=t[a.name]||"";switch(a.type.toLowerCase()){case"select-one":case"text":case"textarea":a.value=n;break;case"radio":case"checkbox":a.checked=a.value==n;break;case"select-multiple":for(var l=a.name.substr(0,a.name.length-2),o=!1,r=0,c=a.options.length;c>r;r++){var d=t[l]?t[l]["sel"+a.options[r].value]:null;a.options[r].selected=a.options[r].value==d,a.options[r].value==d&&(o=!0)}!o&&a.options.length>0&&""==a.options[0].value&&(a.options[0].selected=!0)}a.onchange&&a.onchange()}}},this.GetFilterFields=function(e){for(var t={},i=0,s=e.elements.length;s>i;i++){var a=e.elements[i];if("filter_name"!=a.name)switch(a.type.toLowerCase()){case"select-one":case"text":case"textarea":t[a.name]=a.value;break;case"radio":case"checkbox":a.checked&&(t[a.name]=a.value);break;case"select-multiple":var n=a.name.substr(0,a.name.length-2);t[n]={};for(var l=0,o=a.options.length;o>l;l++)a.options[l].selected&&(t[n]["sel"+a.options[l].value]=a.options[l].value)}}return t},this.SaveFilter=function(e){var i=document["flt_settings_"+this.table_id],s={GRID_ID:this.table_id,filter_id:e,action:"savefilter",sessid:this.vars.sessid,name:i.filter_name.value,fields:this.GetFilterFields(i)};return BX.ajax.post("/bitrix/components"+t.vars.component_path+"/settings.php",s),s},this.ApplyFilter=function(e){var t=document.forms["filter_"+this.table_id];this.SetFilterFields(t,this.oOptions.filters[e].fields),BX.submit(t)},this.OnDateChange=function(e){var t=!1,i=!1,s=!1,a=!1,n=!1;"interval"==e.value?n=t=i=s=!0:"before"==e.value?i=!0:"after"==e.value||"exact"==e.value?t=!0:"days"==e.value&&(a=!0),BX.findNextSibling(e,{tag:"span","class":"bx-filter-from"}).style.display=t?"":"none",BX.findNextSibling(e,{tag:"span","class":"bx-filter-to"}).style.display=i?"":"none",BX.findNextSibling(e,{tag:"span","class":"bx-filter-hellip"}).style.display=s?"":"none",BX.findNextSibling(e,{tag:"span","class":"bx-filter-days"}).style.display=a?"":"none";var l=BX.findNextSibling(e,{tag:"span","class":"bx-filter-br"});l&&(l.style.display=n?"":"none")}}